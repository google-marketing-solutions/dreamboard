<div class="videos-container">
  <div class="videos">
    @if (scene.videoGenerationSettings.generatedVideos.length === 0) {
      <p>
        Your video will show here. <br />
        <mat-icon>videocam</mat-icon>
      </p>
    } @else {
      <div class="carousel">
        @for (
          video of scene.videoGenerationSettings.generatedVideos;
          track video;
          let i = $index
        ) {
          @if (i === currentGeneratedVideoIndex) {
            <video controls class="generated-file">
              <source [src]="video.signedUri" type="video/mp4" />
            </video>
          }
        }
      </div>
      <div class="c-buttons">
        <button mat-mini-fab (click)="onPrev()">
          <mat-icon>arrow_back_ios</mat-icon>
        </button>
        <button mat-mini-fab (click)="onNext()">
          <mat-icon>arrow_forward_ios</mat-icon>
        </button>
      </div>
    }
  </div>
  @if (scene.videoGenerationSettings.generatedVideos.length > 0) {
    <button mat-button>
      <mat-icon>download</mat-icon>
      <a
        [href]="scene.videoGenerationSettings.selectedVideoForMerge?.signedUri"
        download
        [download]="scene.videoGenerationSettings.selectedVideoForMerge?.name"
        target="_blank"
        >Video</a
      >
    </button>
  }
</div>

<form [formGroup]="videoSettingsForm">
  <mat-form-field class="selected-video-for-merge">
    <mat-label>Selected Video For Merge</mat-label>
    <mat-select
      name="selectedVideoUri"
      formControlName="selectedVideoUri"
      (selectionChange)="onVideoSelected($event)"
    >
      @for (
        video of scene.videoGenerationSettings.generatedVideos;
        track video;
        let i = $index
      ) {
        <mat-option [value]="video.gcsUri" [id]="i.toString()">{{
          video.name
        }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <h2>Video Generation Settings</h2>
  <div class="item-container-small">
    <mat-form-field>
      <mat-label>Veo Model</mat-label>
      <mat-select
        formControlName="videoModel"
        (selectionChange)="onVideoModelSelected($event)"
      >
        @for (
          videoModelsOption of videoModelsOptions;
          track videoModelsOption.value
        ) {
          <mat-option [value]="videoModelsOption.value">{{
            videoModelsOption.displayName
          }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Task</mat-label>
      <mat-select
        formControlName="videoGenTask"
        (selectionChange)="onVideoGenTaskSelected($event)"
      >
        @for (
          videoGenTasksOption of videoGenTasksOptions;
          track videoGenTasksOption.value
        ) {
          <mat-option [value]="videoGenTasksOption.value">{{
            videoGenTasksOption.displayName
          }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Assets (images/videos) selection area -->
  <div class="assets-selection-container">
    @if (
      (scene.imageGenerationSettings.selectedImagesForVideo &&
        scene.imageGenerationSettings.selectedImagesForVideo.length >
          getMaxAllowedSelectedAssets()) ||
      (scene.videoGenerationSettings.selectedVideosForExtension &&
        scene.videoGenerationSettings.selectedVideosForExtension.length >
          getMaxAllowedSelectedAssets())
    ) {
      <div class="max-allowed-warning">
        <span>
          <mat-icon>warning</mat-icon>
          Max allowed number of assets for selected Video Model and Task is
          <strong>{{ getMaxAllowedSelectedAssets() }}</strong
          >.
        </span>
      </div>
    }
    @if (
      (this.videoSettingsForm.get("videoModel")?.value === VEO_3_1_MODEL_NAME &&
        this.videoSettingsForm.get("videoGenTask")?.value ===
          "image-to-video") ||
      (this.videoSettingsForm.get("videoModel")?.value ===
        VEO_3_1_FAST_MODEL_NAME &&
        this.videoSettingsForm.get("videoGenTask")?.value === "image-to-video")
    ) {
      <div class="info">
        <span
          ><mat-icon>info</mat-icon> You can generate videos by specifying the
          first and last frames of the video.</span
        >
      </div>
      <div class="image-to-video">
        <div class="uploader-item">
          <app-file-uploader-new
            (fileUploadedEventNew)="addUploadedFile($event)"
            (fileDeletedEventNew)="onAssetDeleted($event)"
            [storyId]="this.storyId"
            [sceneId]="scene.id"
            [fileType]="getFileType('referenceImage')"
            [enableMultipleFiles]="false"
          ></app-file-uploader-new>
          <span>Start</span>
        </div>
        <div class="uploader-item">
          <app-file-uploader-new
            (fileUploadedEventNew)="addUploadedFile($event)"
            (fileDeletedEventNew)="onAssetDeleted($event)"
            [storyId]="this.storyId"
            [sceneId]="scene.id"
            [fileType]="getFileType('referenceImage')"
            [enableMultipleFiles]="false"
          ></app-file-uploader-new>
          <span>End (Optional)</span>
        </div>
        <span>OR</span>
        <button mat-flat-button (click)="openAssetsSelectionDialog('images')">
          <mat-icon>upload</mat-icon>
          Images from Library
        </button>
      </div>
    }

    @if (
      (this.videoSettingsForm.get("videoModel")?.value === VEO_3_1_MODEL_NAME &&
        this.videoSettingsForm.get("videoGenTask")?.value ===
          "reference-to-video") ||
      (this.videoSettingsForm.get("videoModel")?.value ===
        VEO_3_1_FAST_MODEL_NAME &&
        this.videoSettingsForm.get("videoGenTask")?.value ===
          "reference-to-video")
    ) {
      <div class="info">
        <span
          ><mat-icon>info</mat-icon> You provide up to three images of a single
          person, character, or product. Veo preserves the subject's appearance
          in the output video.</span
        >
      </div>
      <div class="reference-to-video">
        <div class="uploader-item">
          <app-file-uploader-new
            (fileUploadedEventNew)="addUploadedFile($event)"
            (fileDeletedEventNew)="onAssetDeleted($event)"
            [storyId]="this.storyId"
            [sceneId]="scene.id"
            [fileType]="getFileType('referenceImage')"
            [enableMultipleFiles]="true"
          ></app-file-uploader-new>
          <span>(Up to 3 images)</span>
        </div>
        <span>OR</span>
        <button mat-flat-button (click)="openAssetsSelectionDialog('images')">
          <mat-icon>upload</mat-icon>
          Images from Library
        </button>
      </div>
    }

    @if (
      (this.videoSettingsForm.get("videoModel")?.value === VEO_3_1_MODEL_NAME &&
        this.videoSettingsForm.get("videoGenTask")?.value ===
          "video-extension") ||
      (this.videoSettingsForm.get("videoModel")?.value ===
        VEO_3_1_FAST_MODEL_NAME &&
        this.videoSettingsForm.get("videoGenTask")?.value === "video-extension")
    ) {
      <div class="info">
        <span
          ><mat-icon>info</mat-icon> You can extend videos that you previously
          generated using Veo that are 1 to 30 seconds in length.</span
        >
      </div>
      <div class="library-button-container">
        <button mat-flat-button (click)="openAssetsSelectionDialog('videos')">
          <mat-icon>upload</mat-icon>
          Videos from Library
        </button>
      </div>
    }

    @if (
      (this.videoSettingsForm.get("videoModel")?.value === VEO_3_MODEL_NAME &&
        this.videoSettingsForm.get("videoGenTask")?.value ===
          "image-to-video") ||
      (this.videoSettingsForm.get("videoModel")?.value ===
        VEO_3_FAST_MODEL_NAME &&
        this.videoSettingsForm.get("videoGenTask")?.value === "image-to-video")
    ) {
      <div class="info">
        <span
          ><mat-icon>info</mat-icon> You can select a single image as reference
          for your video.</span
        >
      </div>
      <div class="image-to-video">
        <div class="uploader-item">
          <app-file-uploader-new
            (fileUploadedEventNew)="addUploadedFile($event)"
            (fileDeletedEventNew)="onAssetDeleted($event)"
            [storyId]="this.storyId"
            [sceneId]="scene.id"
            [fileType]="getFileType('referenceImage')"
            [enableMultipleFiles]="false"
          ></app-file-uploader-new>
          <span>Start</span>
        </div>
        <span>OR</span>
        <button mat-flat-button (click)="openAssetsSelectionDialog('images')">
          <mat-icon>upload</mat-icon>
          Images from Library
        </button>
      </div>
    }
  </div>

  <div class="selected-assets-for-video">
    @if (
      scene.imageGenerationSettings.selectedImagesForVideo &&
      scene.imageGenerationSettings.selectedImagesForVideo.length > 0
    ) {
      <span>Selected Images for Video Generation</span>
      <div class="delete-all-assets-container">
        <button matButton (click)="clearAssets()">
          <mat-icon>close</mat-icon>Clear All
        </button>
      </div>
      <div class="assets-list">
        @for (
          image of scene.imageGenerationSettings.selectedImagesForVideo;
          let i = $index;
          track image.id + "-" + i
        ) {
          <div class="asset-item">
            <img [src]="image.signedUri" />
            <mat-icon matTooltip="Delete" (click)="onAssetDeleted(image)"
              >close</mat-icon
            >
          </div>
        }
      </div>
    }

    @if (
      scene.videoGenerationSettings.selectedVideosForExtension &&
      scene.videoGenerationSettings.selectedVideosForExtension.length > 0
    ) {
      <span>Selected Videos for Video Extension</span>
      <div>
        @for (
          video of scene.videoGenerationSettings.selectedVideosForExtension;
          let i = $index;
          track video.id + "-" + i
        ) {
          <div class="asset-item">
            <video controls>
              <source [src]="video.signedUri" [type]="video.mimeType" />
            </video>
            <mat-icon matTooltip="Delete" (click)="onAssetDeleted(video)"
              >close</mat-icon
            >
          </div>
        }
      </div>
    }
  </div>

  <div class="item-container">
    <mat-form-field>
      <mat-label>Video Prompt</mat-label>
      <textarea
        matInput
        placeholder=""
        rows="5"
        formControlName="prompt"
      ></textarea>
    </mat-form-field>
    <div class="item-buttons">
      <button mat-flat-button (click)="rewriteVideoPrompt()">
        <mat-icon>auto_fix_high</mat-icon>
        Rewrite
      </button>
      <mat-checkbox formControlName="withSceneDescription"
        >With Scene Description</mat-checkbox
      >
    </div>
  </div>

  <mat-form-field>
    <mat-label>Number of Videos</mat-label>
    <input
      matInput
      type="number"
      min="1"
      max="4"
      formControlName="sampleCount"
    />
  </mat-form-field>

  <mat-form-field>
    <mat-label>Duration in Seconds</mat-label>
    <mat-select formControlName="durationInSecs">
      @for (
        durationInSecsOption of durationInSecsOptions;
        track durationInSecsOption.value
      ) {
        <mat-option [value]="durationInSecsOption.value">{{
          durationInSecsOption.displayName
        }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <mat-form-field>
    <mat-label>Aspect Ratio</mat-label>
    <mat-select formControlName="aspectRatio">
      @for (
        aspectRatioOption of aspectRatioOptions;
        track aspectRatioOption.value
      ) {
        <mat-option [value]="aspectRatioOption.value">{{
          aspectRatioOption.displayName
        }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <mat-form-field>
    <mat-label>Frames per Second</mat-label>
    <mat-select formControlName="framesPerSec">
      @for (
        framesPerSecOption of framesPerSecOptions;
        track framesPerSecOption.value
      ) {
        <mat-option [value]="framesPerSecOption.value">{{
          framesPerSecOption.displayName
        }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <mat-form-field>
    <mat-label>Person Generation</mat-label>
    <mat-select formControlName="personGeneration">
      @for (
        personGenerationOption of personGenerationOptions;
        track personGenerationOption.value
      ) {
        <mat-option [value]="personGenerationOption.value">{{
          personGenerationOption.displayName
        }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <mat-form-field>
    <mat-label>Output Resolution</mat-label>
    <mat-select formControlName="outputResolution">
      @for (
        outputResolutionOption of outputResolutionOptions;
        track outputResolutionOption.value
      ) {
        <mat-option [value]="outputResolutionOption.value">{{
          outputResolutionOption.displayName
        }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <!--mat-form-field>
    <mat-label>Seed</mat-label>
    <input matInput formControlName="seed" />
  </mat-form-field-->

  <mat-form-field class="large-textarea">
    <mat-label>Negative Prompt</mat-label>
    <textarea
      matInput
      placeholder=""
      rows="3"
      formControlName="negativePrompt"
    ></textarea>
  </mat-form-field>

  <div>
    <mat-checkbox formControlName="generateAudio">Generate audio</mat-checkbox>
    <!-- COMMENTED OUT FOR Veo3
    <mat-checkbox formControlName="enhancePrompt">Enhance prompt</mat-checkbox-->
    <mat-checkbox formControlName="includeVideoSegment"
      >Include video segment in final video</mat-checkbox
    >
    <mat-checkbox formControlName="regenerateVideo"
      >Regenerate video in bulk generation</mat-checkbox
    >
    <!--mat-checkbox formControlName="cutVideo"
      >Cut video in final video</mat-checkbox
    -->
  </div>

  @if (videoSettingsForm.get("cutVideo")?.value) {
    <form [formGroup]="videoCutSettingsForm">
      <div class="video-cut-settings">
        <h3>Video Cut Settings</h3>
        <p>
          <strong>Note:</strong> The videos will be cut on merge action when you
          click on the 'Merge Videos' button.
        </p>
        <mat-form-field>
          <mat-label>Start Seconds</mat-label>
          <input
            matInput
            type="number"
            min="0"
            max="7"
            formControlName="startSeconds"
          />
        </mat-form-field>
        <mat-form-field>
          <mat-label>Start Frame</mat-label>
          <input
            matInput
            type="number"
            min="0"
            max="23"
            formControlName="startFrame"
          />
        </mat-form-field>
        <mat-form-field>
          <mat-label>End Seconds</mat-label>
          <input
            matInput
            type="number"
            min="0"
            max="7"
            formControlName="endSeconds"
          />
        </mat-form-field>
        <mat-form-field>
          <mat-label>End Frame</mat-label>
          <input
            matInput
            type="number"
            min="0"
            max="23"
            formControlName="endFrame"
          />
        </mat-form-field>
      </div>
    </form>
  }

  <div class="generate-button">
    <button
      mat-flat-button
      aria-label="Generate Video"
      (click)="generateVideosFromScene()"
      [disabled]="disableGenerateVideoButton()"
    >
      <mat-icon>videocam</mat-icon>
      Generate Video
    </button>
  </div>
</form>
