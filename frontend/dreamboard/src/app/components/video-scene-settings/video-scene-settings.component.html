<div class="videos-container">
  <div class="videos">
    @if (scene.videoGenerationSettings.generatedVideos.length === 0) {
    <p>
      Your video will show here. <br />
      <mat-icon>videocam</mat-icon>
    </p>
    } @else {

    <div class="carousel">
      @for (video of scene.videoGenerationSettings.generatedVideos; track video;
      let i = $index) { @if (i === this.currentlyDisplayedVideoIndex) {
      <video controls class="generated-file">
        <source [src]="video.signedUri" type="video/mp4" />
      </video>
      } }
    </div>
    <div class="c-buttons">
      <button mat-mini-fab (click)="onPrev()">
        <mat-icon>arrow_back_ios</mat-icon>
      </button>
      <button mat-mini-fab (click)="onNext()">
        <mat-icon>arrow_forward_ios</mat-icon>
      </button>
    </div>
    }
  </div>
  @if(scene.videoGenerationSettings.generatedVideos.length > 0 &&
  this.currentlyDisplayedVideoIndex >= 0 && this.currentlyDisplayedVideoIndex <
  scene.videoGenerationSettings.generatedVideos.length) {
  <button mat-button>
    <mat-icon>download</mat-icon>
    <a
      [href]="
        this.scene.videoGenerationSettings.generatedVideos[
          this.currentlyDisplayedVideoIndex
        ].signedUri
      "
      download
      [download]="
        this.scene.videoGenerationSettings.generatedVideos[
          this.currentlyDisplayedVideoIndex
        ].name
      "
      target="_blank"
      >Video</a
    >
  </button>
  } @if
  (scene.imageGenerationSettings.imagesSelectionForVideoInfo.selectedImagesForVideo.length
  > 0) {
  <div class="reference-images">
    <h4>
      Selection Type: Image to Video -
      {{
        this.scene.imageGenerationSettings.imagesSelectionForVideoInfo
          .imagesSelectionType
      }}
    </h4>

    @for (image of
    scene.imageGenerationSettings.imagesSelectionForVideoInfo.selectedImagesForVideo;
    track image; let i = $index) {
    <img [src]="image.signedUri" />

    @if(this.scene.imageGenerationSettings.imagesSelectionForVideoInfo.imagesSelectionType
    === 'first-last-frame') { @if(i === 0) {
    <label>[First Frame]</label>
    } @if(i === 1) {
    <label>[Last Frame]</label>
    } } @else {

    <label>[{{ i + 1 }}]</label>
    } }
    <!-- For -->
    <div>
      <button mat-button (click)="removeSelectedImagesForVideo()">
        <mat-icon>delete_forever</mat-icon> Delete Images
      </button>
    </div>
  </div>

  } @else if
  (this.scene.videoGenerationSettings.videosSelectionForVideoInfo.selectedVideosForVideo.length
  > 0) {
  <!-- Prio 2 if users select videos to extend -->
  @for (video of
  this.scene.videoGenerationSettings.videosSelectionForVideoInfo.selectedVideosForVideo;
  track video.id; let i = $index) {
  <div class="reference-videos">
    <h4>Selection Type: Video to Video Extension</h4>
    <div>
      <video controls>
        <source [src]="video.signedUri" type="video/mp4" />
      </video>
    </div>
    <div>
      <button mat-button (click)="removeSelectedVideosForVideo()">
        <mat-icon>delete_forever</mat-icon> Delete Videos
      </button>
    </div>
  </div>
  } } @else {
  <div class="no-reference-images">
    <p>
      <mat-icon>warning</mat-icon>You haven't selected reference images or videos for
      your video. Reference images improve video accuracy and quality.
    </p>
    <div class="go-to-buttons">
      <button mat-flat-button (click)="goToImagesSelectionForVideoTab()">
        <mat-icon>image</mat-icon> Select Images
      </button>
      <button mat-flat-button (click)="goToVideosSelectionForVideoTab()">
        <mat-icon>videocam</mat-icon> Select Videos
      </button>
    </div>
  </div>
  }
</div>

<form [formGroup]="videoSettingsForm">
  <div>
    Use the dropdown below to select the video segment to
    <strong>merge in the final video</strong>.
  </div>
  <mat-form-field class="selected-video">
    <mat-label>Selected Video For Merge</mat-label>
    <mat-select
      name="selectedVideoForMergeUri"
      formControlName="selectedVideoForMergeUri"
      (selectionChange)="onVideoSelected($event)"
    >
      @for (video of scene.videoGenerationSettings.generatedVideos; track video;
      let i = $index) {
      <mat-option [value]="video.gcsUri" [id]="i.toString()">{{
        video.name
      }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <!-- Generated videos table -->
  <app-generated-videos-table
    [generatedVideos]="scene.videoGenerationSettings.generatedVideos"
    (generatedVideoDeletedEvent)="onGeneratedVideoDeleted($event)"
    [isSelectionMode]="false"
  ></app-generated-videos-table>

  <h2>Video Generation Settings</h2>

  <mat-form-field>
    <mat-label>Video Model Name</mat-label>
    <mat-select formControlName="videoModelName">
      @for (videoModelNameOption of videoModelNameOptions; track
      videoModelNameOption) {
      <mat-option [value]="videoModelNameOption.value">{{
        videoModelNameOption.displayName
      }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  @if(this.scene.imageGenerationSettings.imagesSelectionForVideoInfo.selectedImagesForVideo.length
  > 0) {
  <!-- This has priority 0 -->
  <span>
    To update the Video Model Name when using reference images, please return to
    the <strong>(Optional) Images Selection for Video</strong> tab.</span
  >
  } @else if
  (this.scene.videoGenerationSettings.videosSelectionForVideoInfo.selectedVideosForVideo.length
  > 0) {
  <!-- This has priority 1 -->
  <span>
    To update the Video Model Name when using reference videos, please return to
    the <strong>(Optional) Video Selection for Extension</strong> tab.</span
  >
  } @else {
  <!---->
  }

  <div class="item-container">
    <mat-form-field>
      <mat-label>Video Prompt</mat-label>
      <textarea
        matInput
        placeholder=""
        rows="5"
        formControlName="prompt"
      ></textarea>
    </mat-form-field>
    <div class="item-buttons">
      <button mat-flat-button (click)="rewriteVideoPrompt()">
        <mat-icon>auto_fix_high</mat-icon>
        Rewrite
      </button>
      <mat-checkbox formControlName="withSceneDescription"
        >With Scene Description</mat-checkbox
      >
    </div>
  </div>

  <mat-form-field>
    <mat-label>Number of Videos</mat-label>
    <input
      matInput
      type="number"
      min="1"
      max="4"
      formControlName="sampleCount"
    />
  </mat-form-field>

  <mat-form-field>
    <mat-label>Duration in Seconds</mat-label>
    <mat-select formControlName="durationInSecs">
      <mat-option [value]="4">4</mat-option>
      <mat-option [value]="6">6</mat-option>
      <mat-option [value]="8">8</mat-option>
    </mat-select>
  </mat-form-field>

  <mat-form-field>
    <mat-label>Aspect Ratio</mat-label>
    <mat-select formControlName="aspectRatio">
      @for (aspectRatios of aspectRatios; track aspectRatios) {
      <mat-option [value]="aspectRatios.value">{{
        aspectRatios.displayName
      }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <mat-form-field>
    <mat-label>Frames per Second</mat-label>
    <mat-select formControlName="framesPerSec">
      @for (framesPerSecOption of framesPerSecOptions; track framesPerSecOption)
      {
      <mat-option [value]="framesPerSecOption.value">{{
        framesPerSecOption.displayName
      }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <mat-form-field>
    <mat-label>Person Generation</mat-label>
    <mat-select formControlName="personGeneration">
      @for (personGenerationOption of personGenerationOptions; track
      personGenerationOption) {
      <mat-option [value]="personGenerationOption.value">{{
        personGenerationOption.displayName
      }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <mat-form-field>
    <mat-label>Output Resolution</mat-label>
    <mat-select formControlName="outputResolution">
      @for (outputResolutionOption of outputResolutionOptions; track
      outputResolutionOption) {
      <mat-option [value]="outputResolutionOption.value">{{
        outputResolutionOption.displayName
      }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  <!--mat-form-field>
    <mat-label>Seed</mat-label>
    <input matInput formControlName="seed" />
  </mat-form-field-->

  <mat-form-field class="large-textarea">
    <mat-label>Negative Prompt</mat-label>
    <textarea
      matInput
      placeholder=""
      rows="3"
      formControlName="negativePrompt"
    ></textarea>
  </mat-form-field>

  <div>
    <mat-checkbox formControlName="generateAudio">Generate audio</mat-checkbox>
    <!-- COMMENTED OUT FOR Veo3
    <mat-checkbox formControlName="enhancePrompt">Enhance prompt</mat-checkbox-->
    <mat-checkbox formControlName="includeVideoSegment"
      >Include video segment in final video</mat-checkbox
    >
    <mat-checkbox formControlName="regenerateVideo"
      >Regenerate video in bulk generation</mat-checkbox
    >
    <mat-checkbox formControlName="cutVideo"
      >Cut video in final video</mat-checkbox
    >
  </div>

  @if (videoSettingsForm.get('cutVideo')?.value) {
  <form [formGroup]="videoCutSettingsForm">
    <div class="video-cut-settings">
      <h3>Video Cut Settings</h3>
      <p>
        <strong>Note:</strong> The videos will be cut on merge action when you
        click on the 'Merge Videos' button.
      </p>
      <mat-form-field>
        <mat-label>Start Seconds</mat-label>
        <input
          matInput
          type="number"
          min="0"
          max="7"
          formControlName="startSeconds"
        />
      </mat-form-field>
      <mat-form-field>
        <mat-label>Start Frame</mat-label>
        <input
          matInput
          type="number"
          min="0"
          max="23"
          formControlName="startFrame"
        />
      </mat-form-field>
      <mat-form-field>
        <mat-label>End Seconds</mat-label>
        <input
          matInput
          type="number"
          min="0"
          max="7"
          formControlName="endSeconds"
        />
      </mat-form-field>
      <mat-form-field>
        <mat-label>End Frame</mat-label>
        <input
          matInput
          type="number"
          min="0"
          max="23"
          formControlName="endFrame"
        />
      </mat-form-field>
    </div>
  </form>
  }

  <div class="generate-button">
    <button
      mat-flat-button
      aria-label="Generate Video"
      (click)="generateVideosFromScene()"
      [disabled]="disableGenerateVideoButton()"
    >
      <mat-icon>videocam</mat-icon>
      Generate Video
    </button>
  </div>
</form>
